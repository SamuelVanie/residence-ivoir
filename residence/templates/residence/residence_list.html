{% load static %} {% include 'residence/navbar.html' %}
<link rel="stylesheet" href="{% static 'css/residence_list.css' %}" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>Nos Résidences</title>
<body>
  <div class="page-wrapper">
    
    <main class="main-content">
      <div class="filter-controls">
        <div class="filter-dropdown-container">
          <select id="roomFilterDropdown" name="rooms">
            <option value="">Nombre de chambre</option>
            <option value="1">1 chambre</option>
            <option value="2">2 chambres</option>
            <option value="3">3 chambres</option>
            <option value="4">4 chambres</option>
            <option value="5">5+ chambres</option>
          </select>
        </div>
        <!-- New Budget Filter Button (visible on small screens) -->
        <button id="budgetFilterBtn" class="btn btn-filter">Filtrer par budget</button>
      </div>

      <section id="residenceList" class="residence-list-area">
        {% for residence in page_obj %}
        <article class="residence-card"
                 data-id="{{ residence.id }}"
                 data-name="{{ residence.name|escapejs }}"
                 data-rooms="{{ residence.number_of_rooms | default:'unknown' }}"
                 data-price=" {{ residence.price_per_night|default:residence.price }}"
        >
          <img
            class="residence-image"
            src="{% if residence.image %}{{ residence.image.url }}{% else %}{% static 'images/default_residence.jpg' %}{% endif %}"
            alt="Image de {{ residence.name }}"
          />
          <div class="residence-info">
            <div class="residence-header">
              <h3 class="residence-name">{{ residence.name }}</h3>
              <p class="residence-price">{{ residence.price_per_night|default:residence.price }} FCFA/nuit</p>
            </div>
            <p class="residence-subtitle">
              {% if residence.number_of_rooms %}{{ residence.number_of_rooms }} chambre(s){% endif %}
              {% if residence.location and not residence.short_description%}, {{ residence.location }}{% endif %}
            </p>

            {# --- Description Section --- #}
            {% if residence.description %}
            <p class="residence-description truncated">
              {{ residence.description|safe }} {# Output the full description here #}
            </p>
            {% endif %}
            {# --- End Description Section --- #}

            {% if residence.promotional_price %}
            <p class="residence-promo-price">
              Promo: {{ residence.promotional_price }} FCFA/nuit
            </p>
            {% endif %}
            {% if residence.is_available is not None %}
            <p class="residence-availability">
              {% if residence.is_available %}
              <span class="available">Disponible</span>
              {% else %}
              <span class="not-available">Non Disponible</span>
              {% endif %}
            </p>
            {% endif %}
            <div class="residence-actions">
              {# CHANGE: Use button for Details toggle #}
              {% if residence.description %}
              <button type="button" class="btn btn-details description-toggle">Details...</button>
              {% endif %}
              {# Keep reserve as a link #}
              <button type="button" class="btn btn-reserve"
                      data-residence-id="{{ residence.id }}"
                      data-residence-name="{{ residence.name }}"
              >Réserver</button>
            </div>
          </div>
        </article>
        {% empty %}
        <p class="no-results-message">Aucune résidence trouvée correspondant à vos critères initiaux.</p>
        {% endfor %}
      </section>

      <nav class="pagination">
        {# Pagination content remains the same #}
        {% if page_obj.has_other_pages %}
        <span class="step-links">
          {% if page_obj.has_previous %}
          <a href="?page=1" class="page-link">« début</a>
          <a href="?page={{ page_obj.previous_page_number }}" class="page-link">‹ préc</a>
          {% else %}
          <span class="page-link disabled">« début</span>
          <span class="page-link disabled">‹ préc</span>
          {% endif %}
          {% for num in page_obj.paginator.page_range %}
          {% if page_obj.number == num %}
          <span class="page-link current">{{ num }}</span>
          {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
          <a href="?page={{ num }}" class="page-link">{{ num }}</a>
          {% elif num == 1 %}
          {% elif num == page_obj.paginator.num_pages %}
          {% endif %}
          {% endfor %}
          {% if page_obj.has_next %}
          <a href="?page={{ page_obj.next_page_number }}" class="page-link">suiv ›</a>
          <a href="?page={{ page_obj.paginator.num_pages }}" class="page-link">fin »</a>
          {% else %}
          <span class="page-link disabled">suiv ›</span>
          <span class="page-link disabled">fin »</span>
          {% endif %}
        </span>
        {% endif %}
      </nav>
    </main>

    <!-- Keep the sidebar for larger screens -->
    <aside class="filter-sidebar" id="budget-filter">
      <h2 class="filter-title">Budget</h2>
      <div class="filter-group">
        <div class="budget-option">
          <input type="radio" id="budgetRange50_100" name="budget_range" value="50000-100000">
          <label for="budgetRange50_100">50 000 FCFA - 100 000 FCFA</label>
        </div>
        <div class="budget-option">
          <input type="radio" id="budgetRange100_150" name="budget_range" value="100000-150000">
          <label for="budgetRange100_150">100 000 FCFA - 150 000 FCFA</label>
        </div>
        <div class="budget-option">
          <input type="radio" id="budgetRange150_200" name="budget_range" value="150000-200000">
          <label for="budgetRange150_200">150 000 FCFA - 200 000 FCFA</label>
        </div>
        <div class="budget-option">
          <input type="radio" id="budgetRange200_250" name="budget_range" value="200000-250000">
          <label for="budgetRange200_250">200 000 FCFA - 250 000 FCFA</label>
        </div>
        <div class="budget-option">
          <input type="radio" id="budgetRange250_inf" name="budget_range" value="250000-inf">
          <label for="budgetRange250_inf">250 000+ FCFA</label>
        </div>
        <div class="budget-option custom-range">
          <div class="custom-inputs">
            <span class="custom-label">Choisir:</span>
            <input type="number" id="minBudget" name="min_budget" placeholder="Min" step="1000">
            <span>à</span>
            <input type="number" id="maxBudget" name="max_budget" placeholder="Max" step="1000">
          </div>
        </div>
      </div>
      <button class="btn btn-clear-filters" onclick="clearFilters()">Effacer Filtres</button>
    </aside>

    <!-- New Budget Filter Modal for small screens -->
    <div id="budget-filter-modal" class="modal">
      <div class="modal-content">
        <span class="modal-close-btn budget-modal-close">×</span>
        <h3>Filtrer par budget</h3>
        <div class="filter-group">
          <div class="budget-option">
            <input type="radio" id="modalBudgetRange50_100" name="modal_budget_range" value="50000-100000">
            <label for="modalBudgetRange50_100">50 000 FCFA - 100 000 FCFA</label>
          </div>
          <div class="budget-option">
            <input type="radio" id="modalBudgetRange100_150" name="modal_budget_range" value="100000-150000">
            <label for="modalBudgetRange100_150">100 000 FCFA - 150 000 FCFA</label>
          </div>
          <div class="budget-option">
            <input type="radio" id="modalBudgetRange150_200" name="modal_budget_range" value="150000-200000">
            <label for="modalBudgetRange150_200">150 000 FCFA - 200 000 FCFA</label>
          </div>
          <div class="budget-option">
            <input type="radio" id="modalBudgetRange200_250" name="modal_budget_range" value="200000-250000">
            <label for="modalBudgetRange200_250">200 000 FCFA - 250 000 FCFA</label>
          </div>
          <div class="budget-option">
            <input type="radio" id="modalBudgetRange250_inf" name="modal_budget_range" value="250000-inf">
            <label for="modalBudgetRange250_inf">250 000+ FCFA</label>
          </div>
          <div class="budget-option custom-range">
            <div class="custom-inputs">
              <span class="custom-label">Choisir:</span>
              <input type="number" id="modalMinBudget" name="modal_min_budget" placeholder="Min" step="1000">
              <span>à</span>
              <input type="number" id="modalMaxBudget" name="modal_max_budget" placeholder="Max" step="1000">
            </div>
          </div>
        </div>
        <div class="modal-actions">
          <button type="button" class="btn btn-clear-filters" id="modalClearFilters">Effacer Filtres</button>
          <button type="button" class="btn btn-apply-filter">Appliquer</button>
        </div>
      </div>
    </div>

    {# --- Reservation Modal --- #}
    <div id="reservation-modal" class="modal">
      <div class="modal-content">
        <span class="modal-close-btn">×</span>
        <h3 id="modalResidenceName">Réserver la résidence</h3>
        <form id="reservationForm" method="POST" action="{% url 'generate_whatsapp_reservation_link' %}">
          {% csrf_token %}
          {# Hidden input to store residence data if needed, or retrieve from button data #}
          <input type="hidden" id="modalResidenceId" name="residence_id">

          <div class="modal-field">
            <label for="reservationDays">Nombre de jours souhaités:</label>
            <input type="number" id="reservationDays" name="days" min="1" required>
          </div>
          <div class="modal-field">
            <label for="reservationDate">Date d'arrivée prévue:</label>
            <input type="date" id="reservationDate" name="arrival_date" required>
          </div>
          <div class="modal-actions">
            <button type="button" class="btn btn-cancel modal-cancel-btn">Annuler</button>
            <button type="submit" class="btn btn-reserve">Confirmer Réservation</button>
          </div>
        </form>
      </div>
    </div>

  </div> {# End page-wrapper #}

  <script>
   const residenceListDiv = document.getElementById("residenceList");
   const paginationDiv = document.querySelector(".pagination");
   const roomFilterDropdown = document.getElementById('roomFilterDropdown');
   const budgetRadios = document.querySelectorAll('input[name="budget_range"]');
   const minBudgetInput = document.getElementById('minBudget');
   const maxBudgetInput = document.getElementById('maxBudget');

   // Modal Elements
   const reservationModal = document.getElementById('reservation-modal');
   const modalCloseBtn = reservationModal.querySelector('.modal-close-btn');
   const modalCancelBtn = reservationModal.querySelector('.modal-cancel-btn');
   const reservationForm = document.getElementById('reservationForm');
   const modalResidenceNameH3 = document.getElementById('modalResidenceName');
   const modalResidenceIdInput = document.getElementById('modalResidenceId'); // Input to set residence_id

   // Budget Filter Modal Elements
   const budgetFilterModal = document.getElementById('budget-filter-modal');
   const budgetFilterBtn = document.getElementById('budgetFilterBtn');
   const budgetModalClose = budgetFilterModal.querySelector('.budget-modal-close');
   const modalBudgetRadios = document.querySelectorAll('input[name="modal_budget_range"]');
   const modalMinBudgetInput = document.getElementById('modalMinBudget');
   const modalMaxBudgetInput = document.getElementById('modalMaxBudget');
   const applyFilterBtn = budgetFilterModal.querySelector('.btn-apply-filter');
   const modalClearFiltersBtn = document.getElementById('modalClearFilters');
   
   // --- HTML Generation (Update to include description) ---
   function generateResidenceHTML(residence) {
     const imageUrl = residence.image_url || '{% static "images/default_residence.jpg" %}';
     const price = residence.price_per_night || residence.price || 'N/A';
     const promoPrice = residence.promotional_price_per_night;
     const isAvailable = residence.is_available;
     const description = residence.description || '';
     const residenceId = residence.id
     const name = residence.name || '';

     let subtitle = '';
     if (residence.number_of_rooms) subtitle += `${residence.number_of_rooms} chambre(s)`;
     if (residence.location) subtitle += `${subtitle ? ', ' : ''}${residence.location}`;

     let promoHTML = "";
     if (promoPrice) {
       promoHTML = `<p class="residence-promo-price">Promo: ${promoPrice} FCFA/nuit</p>`;
     }

     let availabilityHTML = "";
     if (isAvailable !== undefined && isAvailable !== null) {
       availabilityHTML = `<p class="residence-availability">${isAvailable ? '<span class="available">Disponible</span>' : '<span class="not-available">Non Disponible</span>'}</p>`;
     }

     let descriptionHTML = "";
     if (description) {
       descriptionHTML = `<p class="residence-description truncated">${description}</p>`;
     }

     // ADD: Conditionally show Details button only if there is a description
     let detailsButtonHTML = "";
     if (description) {
       detailsButtonHTML = `<button type="button" class="btn btn-details description-toggle">Details...</button>`;
     }

     // reserve_url if someday we want to use something else than whatsapp message
     const reserveUrl = residence.reserve_url || '#';


     const reserveButtonHTML = `
       <button type="button" class="btn btn-reserve"
               data-residence-id="${residenceId}"
               data-residence-name="${escapeJS(name)}">Réserver</button>`;

     return `
          <article class="residence-card" data-id="${residenceId}" data-name="${escapeJS(name)}">
            <img class="residence-image" src="${imageUrl}" alt="Image de ${name}">
            <div class="residence-info">
              <div class="residence-header">
                <h3 class="residence-name">${name}</h3>
                <p class="residence-price">${price} FCFA/nuit</p>
              </div>
              <p class="residence-subtitle">${subtitle || ''}</p>
              ${descriptionHTML} {# Inject description HTML #}
              ${promoHTML}
              ${availabilityHTML}
              <div class="residence-actions">
                 ${detailsButtonHTML}
                 ${reserveButtonHTML}
              </div>
            </div>
          </article>
     `;
   }


   function escapeJS(str) {
     if (!str) return '';
     return String(str).replace(/"/g, '"').replace(/'/g, '\'');
   }

   
   // --- Update UI ---
   function updateResidenceList(data) {
     let residenceHTML = "";
     if (data && data.length > 0) {
       data.forEach((residence) => {
         residenceHTML += generateResidenceHTML(residence);
       });
     } else {
       residenceHTML = "<p class='no-results-message'>Aucune résidence trouvée correspondant à vos critères.</p>";
     }
     residenceListDiv.innerHTML = residenceHTML;
     if (paginationDiv) {
       paginationDiv.style.display = "none";
     }
   }

   function showLoadingIndicator() {
     residenceListDiv.innerHTML = '<p class="loading-message">Chargement...</p>';
     if (paginationDiv) {
       paginationDiv.style.display = "none";
     }
   }

   function showError(message) {
     residenceListDiv.innerHTML = `<p class="error-message">Erreur: ${message}</p>`;
   }


   // --- Filtering Functions ---
   function filterResidencesByRooms() {
     const rooms = roomFilterDropdown.value;
     if (!rooms) {
       clearFilters();
       return;
     }
     budgetRadios.forEach((radio) => (radio.checked = false));
     minBudgetInput.value = "";
     maxBudgetInput.value = "";
     modalBudgetRadios.forEach((radio) => (radio.checked = false));
     modalMinBudgetInput.value = "";
     modalMaxBudgetInput.value = "";
     showLoadingIndicator();
     fetch(`/residences/filter_by_rooms/rooms${rooms}/`)
       .then(response => { if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`); return response.json(); })
       .then(updateResidenceList)
       .catch(error => { console.error("Fetch error (rooms):", error); showError("Impossible de charger les résidences."); });
   }

   function filterResidencesByBudget(fromModal = false) {
     let minBudget, maxBudget, budgetRange;
     
     if (fromModal) {
       minBudget = modalMinBudgetInput.value;
       maxBudget = modalMaxBudgetInput.value;
       budgetRange = document.querySelector('input[name="modal_budget_range"]:checked');
     } else {
       minBudget = minBudgetInput.value;
       maxBudget = maxBudgetInput.value;
       budgetRange = document.querySelector('input[name="budget_range"]:checked');
     }
     
     roomFilterDropdown.value = "";

     if (budgetRange) {
       const rangeValues = budgetRange.value.split("-");
       minBudget = rangeValues[0];
       maxBudget = rangeValues[1] === "inf" ? "" : rangeValues[1];
       
       // Sync both UI states
       minBudgetInput.value = "";
       maxBudgetInput.value = "";
       modalMinBudgetInput.value = "";
       modalMaxBudgetInput.value = "";
       
       // Sync radio buttons
       if (fromModal) {
         const sidebarEquivalent = document.querySelector(`input[name="budget_range"][value="${budgetRange.value}"]`);
         if (sidebarEquivalent) sidebarEquivalent.checked = true;
       } else {
         const modalEquivalent = document.querySelector(`input[name="modal_budget_range"][value="${budgetRange.value}"]`);
         if (modalEquivalent) modalEquivalent.checked = true;
       }
     } else if (minBudget || maxBudget) {
       // Sync custom inputs
       if (fromModal) {
         minBudgetInput.value = minBudget;
         maxBudgetInput.value = maxBudget;
       } else {
         modalMinBudgetInput.value = minBudget;
         modalMaxBudgetInput.value = maxBudget;
       }
       
       // Clear radio selections
       budgetRadios.forEach((radio) => (radio.checked = false));
       modalBudgetRadios.forEach((radio) => (radio.checked = false));
     } else {
       return;
     }

     const queryParams = new URLSearchParams();
     if (minBudget !== null && minBudget !== "") queryParams.append("min_budget", minBudget);
     if (maxBudget !== null && maxBudget !== "") queryParams.append("max_budget", maxBudget);

     if (queryParams.toString() === "") {
       clearFilters();
       return;
     }
     showLoadingIndicator();
     fetch(`/residences/filter_by_budget/?${queryParams.toString()}`)
       .then(response => { if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`); return response.json(); })
       .then(updateResidenceList)
       .catch(error => { console.error("Fetch error (budget):", error); showError("Impossible de charger les résidences."); });
     
     // Close modal if filtering from modal
     if (fromModal) {
       closeBudgetModal();
     }
   }

   // --- Clear Filters ---
   function clearFilters() {
     roomFilterDropdown.value = "";
     minBudgetInput.value = "";
     maxBudgetInput.value = "";
     modalMinBudgetInput.value = "";
     modalMaxBudgetInput.value = "";
     budgetRadios.forEach((radio) => (radio.checked = false));
     modalBudgetRadios.forEach((radio) => (radio.checked = false));
     window.location.href = window.location.pathname;
   }

   // --- Description Toggle Function ---
   function toggleDescription(button) {
     const infoDiv = button.closest('.residence-info');
     if (!infoDiv) return; // Should not happen

     const descriptionP = infoDiv.querySelector('.residence-description');
     if (!descriptionP) return; // Should not happen if button exists

     const isTruncated = descriptionP.classList.contains('truncated');

     if (isTruncated) {
       descriptionP.classList.remove('truncated');
       button.textContent = 'Moins...'; // Change button text to "Show less"
       // Optional: Add aria-expanded attribute for accessibility
       button.setAttribute('aria-expanded', 'true');
     } else {
       descriptionP.classList.add('truncated');
       button.textContent = 'Details...'; // Change button text back
       // Optional: Add aria-expanded attribute for accessibility
       button.setAttribute('aria-expanded', 'false');
     }
   }

   // --- Budget Modal Functions ---
   function openBudgetModal() {
     budgetFilterModal.style.display = 'block';
   }

   function closeBudgetModal() {
     budgetFilterModal.style.display = 'none';
   }

   // --- Event Listeners ---
   roomFilterDropdown.addEventListener('change', filterResidencesByRooms);
   budgetRadios.forEach(radio => radio.addEventListener('change', () => filterResidencesByBudget(false)));
   minBudgetInput.addEventListener('change', () => filterResidencesByBudget(false));
   maxBudgetInput.addEventListener('change', () => filterResidencesByBudget(false));

   // Budget Modal Event Listeners
   budgetFilterBtn.addEventListener('click', openBudgetModal);
   budgetModalClose.addEventListener('click', closeBudgetModal);
   applyFilterBtn.addEventListener('click', () => filterResidencesByBudget(true));
   modalClearFiltersBtn.addEventListener('click', clearFilters);

   // Modal Budget Radio Buttons
   modalBudgetRadios.forEach(radio => {
     radio.addEventListener('change', function() {
       // Just store the selection, apply on button click
     });
   });

   // Clear button listener (if not using onclick)
   const clearButton = document.querySelector('.btn-clear-filters');
   if (clearButton && !clearButton.hasAttribute('onclick')) {
     clearButton.addEventListener('click', clearFilters);
   }

   function openModal(button) {
     const residenceId = button.dataset.residenceId;
     const name = button.dataset.residenceName || 'Cette résidence';
     console.log("Don't forget to remove me---------------");
     console.log(residenceId);

     if (!residenceId) {
       console.error("Cannot open modal: residence ID missing from button.");
       alert("Erreur: Impossible d'ouvrir le formulaire de réservation.");
       return;
     }
     modalResidenceIdInput.value = residenceId;
     modalResidenceNameH3.textContent = `Réserver : ${name}`;
     reservationForm.reset();
     reservationModal.style.display = 'block';
   }

   function closeModal() {
     reservationModal.style.display = 'none';
   }

   residenceListDiv.addEventListener('click', function(event) {
     if (event.target.classList.contains('description-toggle')) {
       toggleDescription(event.target);
     }
     else if (event.target.classList.contains('btn-reserve')) {
       openModal(event.target);
     }
   });

   modalCloseBtn.addEventListener('click', closeModal);
   modalCancelBtn.addEventListener('click', closeModal);

   // Close modals if user clicks outside the modal content
   window.addEventListener('click', function(event) {
     if (event.target == reservationModal) {
       closeModal();
     }
     if (event.target == budgetFilterModal) {
       closeBudgetModal();
     }
   });

  </script>
</body>
{% include 'residence/footer.html' %}
